---
title: "Import Data"
description: "A tutorial about how to import raw tracking data into R env. using the MoveR package."
date: "`r Sys.Date()`"
output: 
  bookdown::html_document2:
    fig_caption: true
    number_sections: false
    global_numbering: false
    link-citations: yes
pkgdown:
  as_is: true
---


<a href="https://qpetitjean.github.io/MoveR/articles/MoveR-ImportData.html" class="previous">&laquo; Previous</a><a href="https://qpetitjean.github.io/MoveR/articles/MoveR-Clean-FilterData.html" class="next">Next &raquo;</a>


We are starting with a basic example of importing raw data from tracking software.

For this example we are selecting the first sample of data available in the <a href="https://github.com/qpetitjean/MoveR_SampleData">MoveR_SampleData</a> github repository. 

Briefly, this dataset come from the video recording (image resolution: 3840x2160) of 12 parasitic micro-wasps (genus <em>Trichogramma</em>) placed in a polygonal arena for 8 minutes at 25 fps  (see fig. \@ref(fig:VideoPics) below) and tracked using <a href="https://trex.run">TRex</a> (Walter and Couzin, 2021).

```{r VideoPics, echo=FALSE, fig.align='center', message=FALSE, warning=FALSE, out.width="100%", fig.cap="Frames extracted from a video recording of 12 parasitic micro-wasps (genus <em>Trichogramma</em>) placed in a polygonal arena."}
knitr::include_graphics(
  "https://github.com/qpetitjean/MoveR_SampleData/raw/main/sample_1/2602_ISA3080_Low_5_Compressed.gif"
)

```

## Download sample data from github.

Now let's download the data.

```{r DLsampleData, echo=TRUE}
# dl the first dataset from the sample data repository
Path2Data <- MoveR::DLsampleData(dataSet = 1, tracker = "TRex")

Path2Data

```

The function download the data from the <a href="https://github.com/qpetitjean/MoveR_SampleData">MoveR_SampleData</a> github repository and returns a vector containing the path to the raw data and the distance matrix helping to locate the edge of the arena and the reference data corresponding to the location particles (manually detected) over several frames (the latters will be useful in another tutorial).

Note that by default the function are saving the sample data within a temporary directory that is deleted when the R session is terminated properly. User can also specify another directory using the `dir` argument from `DLsampleData()`. 
In any case, the function look for previous occurrence of the sample data to avoid multiple downloading.

## Import sample data into R environment.

Once the sample data has been downloaded or retrieved we use `readTrex()` to import the data into `r fontawesome::fa("r-project", fill = "steelblue")` environment.<br />
Note that the same result can be achieved trough the use of `readCtrax()`, `readIdtracker()` or `readTrackR()` depending on the input data. 

Here the raw tracking data are located in the ./MoveR_SampleData-main/sample_1/TREXOutput directory which is the first element of the Path2Data vector.

```{r ImportShortDat, echo=TRUE}
# Import the sample data
Data <-
  MoveR::readTrex(Path2Data[[1]])

str(Data)

```

The function import the data as a list of 9 elements that are the most useful and further used by various functions of the MoveR package. 

Note that output of the various "read" functions is standardized. However, it is also possible to import the output as returned by the tracking software by specifying rawDat = TRUE.

```{r ImportFullDat, echo=TRUE}
# Import the sample data
DataFull <-
  MoveR::readTrex(Path2Data[[1]],
                  rawDat = TRUE)

str(DataFull)

```

In this case, the output of the function returns a list containing 2 sublists, the first corresponding to the one mentioned above and the second containing all the elements as returned by the tracking software.

Also, the argument `mirrorY`, can be used to revert the y coordinates. Indeed some tracking software sets the origin of the y axis on the bottom-left while other use the upper-left corner of the video (see `??readTrex()` for more insight).

## Convert the data to a list of particles tracks (tracklets).

In order to ease the readability and computation performed on tracking data, the list of elements describing the tracking output need to be converted as a list of particles tracks called tracklets. 

To ease further computation, graphical representation and manual inspection the data are converted to a list of tracklets based on particles' identity using `convert2Tracklets()`. 
Here we use only the 7 first element of Data because the last two (i.e., ntargets and timestamps) do not carry the same amount of information and are not useful for the next steps of this tutorial.

```{r Convert, echo=TRUE}
# convert the data to a list of tracklets
# NB: remove ntargets and timestamps because their length is lower than other variables
trackDat <- MoveR::convert2Tracklets(Data[1:7], by = "identity")

str(trackDat[1:3]) # display only the 3 first tracklets

```

Now we can easily look at the trajectory for a given particle by selecting its identity.
For instance, here we are displaying the data frame containing the characteristics of the first particle track.

```{r FirstParticle}
# display the data for the first particle only
str(trackDat[["1"]])

```

It is then easy to look at the particles trajectories.

## First look at the trajectories

Using `drawTracklets()`, it is easy to visualize the trajectories included in the dataset (see fig. \@ref(fig:drawTracklets1)A below), or to focus on the trajectories described only by some particles, here the fifth' first (see fig. \@ref(fig:drawTracklets1)B below).

Note that `drawTracklets()` needs an argument `timeCol` specifying the timeline of the video (here "frame"). One can also specify the resolution of the video to set x and y limits of the plot but as default, the `imgRes` argument use the maximum values recorded in x and y + 5% to set the plots limits (see drawTracklets documentation).

```{r drawTracklets1, echo=TRUE, fig.show="hold", fig.align='center', message=FALSE, warning=FALSE, out.width="100%", fig.width=12, fig.height=5, dpi = 300, fig.cap="Micro-wasps trajectories over the whole video timeline, expressed in frame. A. all trajectories are represented. B. only the first 5 tracklets are represented. The trajectories are colored according to the moments at which they are recorded."}
# split the graphical window in 2 columns
par(mfrow = c(1, 2))

# draw the trajectories of all particles
MoveR::drawTracklets(trackDat,
                     timeCol = "frame")

# add a letter identifying the plot to the upper left corner of the first plot
mtext(
  substitute(paste(bold("A"))),
  side = 3,
  line = 0,
  adj = 0,
  padj = -0.5
)

# draw the trajectories only for the first five particles
MoveR::drawTracklets(
  trackDat,
  selTrack = c(1:5),
  timeCol = "frame"
)

# add a letter identifying the plot to the upper left corner of the second plot
mtext(
  substitute(paste(bold("B"))),
  side = 3,
  line = 0,
  adj = 0,
  padj = -0.5
)

```

otherwise, it is possible to focus on the trajectories recorded within a given time intervals. For instance, between 1 and 999 frames (see fig. \@ref(fig:drawTracklets2)A below) and between 6000 and 6999 frames and 11000, 11999 frames (see fig. \@ref(fig:drawTracklets2)B below).

```{r drawTracklets2, echo=TRUE, fig.align='center', message=FALSE, warning=FALSE, out.width="100%", fig.width=12, fig.height=5, dpi = 300, fig.cap="Micro-wasps trajectories over specified part of the video timeline, expressed in frame. A. all trajectories are represented over a time window of 1000 frames (between 1 and 999 frames). B. all trajectories are represented over two time windows of 1000 frames duration (between 6000 and 6999 and 11000 and 11999 frames). The trajectories are colored according to the moments at which they are recorded."}
# split the graphical window in 2 columns
par(mfrow=c(1,2))

# draw the trajectories over a time window of 1000 frames (between 1 and 999 frames)
MoveR::drawTracklets(
  trackDat,
  timeWin = list(c(1, 999)),
  timeCol = "frame"
)

# add a letter identifying the plot to the upper left corner of the first plot
mtext(substitute(paste(bold("A"))), side = 3, line = 0, adj = 0, padj = -0.5)

# draw the trajectories over two time windows of 1000 frames (between 6000 and 6999 and 11000 and 11999 frames)
MoveR::drawTracklets(
  trackDat,
  timeWin = list(c(6000, 6999), c(11000, 11999)),
  timeCol = "frame"
)

# add a letter identifying the plot to the upper left corner of the second plot
mtext(substitute(paste(bold("B"))), side = 3, line = 0, adj = 0, padj = -0.5)

```

Note that it is also possible to represent specified tracklets over given time window(s) by combining the `selFrags` and `timeWin` arguments respectively.

Finally, drawTracklets allow to color the particles' tracks according to categorical variable, such as the identity of the particle (see fig. \@ref(fig:drawTracklets3)A below). 

However, here the identity of the particles is a numerical variable, we hence need to convert it to a factor, for instance by appending "Tricho" (i.e., part of the micro-wasps genus name) in front of each id. For this purpose, the easiest way is to use the "convert2List" function, transform the identity variable then convert back the data as a list of tracklet using convert2Tracklets as follow: 

```{r convertId}
trackDatList <- MoveR::convert2List(trackDat)
trackDatList[["identity"]] <- paste("Tricho", trackDatList[["identity"]], sep = "_")
trackDat <- MoveR::convert2Tracklets(trackDatList, by = "identity")

str(trackDat)

```

As previously noted, the various arguments from `drawTracklets()` can be combined to emphasize the behavior of particular tracklets over a specified time window (see fig. \@ref(fig:drawTracklets3)B below).

`drawTracklets()` also have various arguments helping to customize the graphical representation, see the function documentation for further information.

```{r drawTracklets3, echo=TRUE, fig.align='center', message=FALSE, warning=FALSE, out.width="100%", fig.width=14, fig.height=6, dpi = 300, fig.cap="Micro-wasps trajectories A. over the whole video timeline, and B. over a time window of 1000 frames (between 1 and 999 frames). Here the trajectories are colored according to the identity of the particle."}
# split the graphical window in 2 columns
par(mfrow=c(1,2))

# draw the trajectories over the whole video timeline and color it according to particles' identity
MoveR::drawTracklets(
  trackDat,
  timeCol = "frame",
  colId = "identity"
)

# add a letter identifying the plot to the upper left corner of the first plot
mtext(substitute(paste(bold("A"))), side = 3, line = 0, adj = 0, padj = -0.5)

# draw the trajectories over two time windows of 1000 frames (between 6000 and 6999 and 11000 and 11999 frames)
MoveR::drawTracklets(
  trackDat,
  timeWin = list(c(1, 999)),
  timeCol = "frame",
  colId = "identity"
)

# add a letter identifying the plot to the upper left corner of the second plot
mtext(substitute(paste(bold("B"))), side = 3, line = 0, adj = 0, padj = -0.5)

```

By looking at the fig. \@ref(fig:drawTracklets3)B, we can see that some particles' tracks are interrupted. This is particularly obvious for Tricho_7 or Tricho_11, let's take a closer look. 

```{r drawTracklets4, echo=TRUE, fig.align='center', message=FALSE, warning=FALSE, out.width="50%", fig.width=7, fig.height=5, dpi = 300, fig.cap="Micro-wasps trajectories for Tricho_7 and Tricho_11 over the whole video timeline."}
# restore the graphical window as default
par(mfrow=c(1,1))

# draw the trajectories over the whole video timeline and color it according to particles' identity
MoveR::drawTracklets(
  trackDat,
  timeCol = "frame",
  colId = "identity",
  selTrack = c("Tricho_7","Tricho_11")
)

```

Indeed, on the fig. \@ref(fig:drawTracklets4) the track of these two individuals are clearly interrupted at multiple location. It indicate that the tracking software have lost or perhaps switched the identity of some animals over the tracking session. The dataset hence need to cleaned/filtered to remove as much artifacts as possible. 

For more insight how to use MoveR to clean and filter your dataset and then run further computation check the next tutorials. 

<strong>Happy coding.</strong>


<a href="https://qpetitjean.github.io/MoveR/articles/MoveR-ImportData.html" class="previous">&laquo; Previous</a><a href="https://qpetitjean.github.io/MoveR/articles/MoveR-Clean-FilterData.html" class="next">Next &raquo;</a>


## References

* Walter, T., Couzin, I.D., 2021. TRex, a fast multi-animal tracking system with markerless identification, and 2D estimation of posture and visual fields. eLife 10, e64000. https://doi.org/10.7554/eLife.64000